<!DOCTYPE html>
<html>

<head>
<title>Maze Navigation Experiment</title>
<link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" type="text/css" />
<script src="https://unpkg.com/jspsych@8.2.1"></script>
<script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
<script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
<script src="https://unpkg.com/@jspsych/plugin-fullscreen@2.1.0"></script>
</head>

<body>
<div id="jspsych-target"></div>

<script>
// --- Experiment Parameters ---
const base_image_path = "https://raw.githubusercontent.com/basakguvensin/maze-images/main/images/";

// Your maze images
const maze_images = [
"maze_closer.png",
"maze_closest.png",
"maze_goal.png",
"maze_initial.png"
];

const target_image = "maze_goal.png"; // The target image participants should respond to
const nTrialsPerImage = 30; // How many times each image appears
const targetRepeats = 10; // How many times target appears per cycle

const iti = 1200; // Inter-trial interval (msec)
const shapePresentationDuration = 600; // Image display duration (msec)

const feedbackColor = '#008000'; // Green for correct responses
const wrongColor = '#FF0000'; // Red for incorrect responses
const feedbackDuration = 300; // How long the border color stays changed after a response

// Function to download data as CSV
function downloadData(experimentData, filename) {
    console.log('Creating CSV from data:', experimentData.values());
    
    // Create CSV with only the relevant columns
    const csv = experimentData.ignore(['stimulus', 'trial_type', 'trial_index', 'time_elapsed', 'internal_node_id']).csv();
    
    console.log('CSV created:', csv.substring(0, 200) + '...');
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    console.log('Download initiated for file:', filename);
}

async function runExperiment() {
const jsPsych = initJsPsych({
on_finish: function (data) {
    console.log('Experiment finished, processing data...');
    
    // Filter data to only include experimental trials (exclude instructions, preload, etc.)
    const experimentData = data.filter({trial_type: 'html-keyboard-response'}).filterCustom(function(trial) {
        return trial.image_name !== undefined; // Only trials with image_name are experimental trials
    });
    
    console.log('Filtered experiment data:', experimentData.values());
    
    // Store data for researcher access (only visible in console/developer tools)
    window.experimentData = experimentData;
    console.log('CSV Data:', experimentData.ignore(['stimulus', 'trial_type', 'trial_index', 'time_elapsed', 'internal_node_id']).csv());
    
    // Participant-friendly completion screen (no data shown)
    document.body.innerHTML = `
    <div id="jspsych-target">
        <div id="doneText" style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
            <h2>Experiment Complete!</h2>
            <p style="font-size: 20px; margin: 30px 0;"><strong>Thank you for your participation.</strong></p>
            <p style="font-size: 16px; color: #666; margin-top: 40px;">
                Your responses have been recorded successfully.
            </p>
            <p style="font-size: 16px; color: #666;">
                You may now close this window or return to Prolific.
            </p>
            
            <!-- Hidden researcher access - only visible if you know to look for it -->
            <div id="researcherAccess" style="display: none;">
                <button id="downloadBtn" style="padding: 15px 30px; font-size: 18px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px;">
                    üì• Download Data (CSV)
                </button>
                <button id="viewDataBtn" style="padding: 15px 30px; font-size: 18px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px;">
                    üëÅÔ∏è View Data
                </button>
                <div id="dataDisplay" style="display: none; margin-top: 20px; text-align: left; max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 15px;">
                </div>
            </div>
        </div>
    </div>
    `;
    
    // Secret researcher access: Type "researcher" to show download buttons
    let secretCode = "";
    document.addEventListener('keydown', function(e) {
        secretCode += e.key.toLowerCase();
        if (secretCode.includes('researcher')) {
            document.getElementById('researcherAccess').style.display = 'block';
            secretCode = ""; // Reset
            
            // Add event listeners for buttons
            setTimeout(() => {
                const downloadBtn = document.getElementById('downloadBtn');
                const viewDataBtn = document.getElementById('viewDataBtn');
                
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', function() {
                        console.log('Download button clicked');
                        const now = new Date();
                        const timestamp = now.getFullYear() + '-' + 
                                         (now.getMonth()+1).toString().padStart(2,'0') + '-' + 
                                         now.getDate().toString().padStart(2,'0') + '_' + 
                                         now.getHours().toString().padStart(2,'0') + '-' + 
                                         now.getMinutes().toString().padStart(2,'0');
                        downloadData(window.experimentData, `maze_experiment_data_${timestamp}.csv`);
                    });
                }
                
                if (viewDataBtn) {
                    viewDataBtn.addEventListener('click', function() {
                        const dataDisplay = document.getElementById('dataDisplay');
                        if (dataDisplay.style.display === 'none') {
                            // Create a formatted view of key data columns
                            let tableHTML = '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
                            tableHTML += '<tr style="background-color: #f8f9fa;"><th style="border: 1px solid #ddd; padding: 8px;">Trial</th><th style="border: 1px solid #ddd; padding: 8px;">Stimulus</th><th style="border: 1px solid #ddd; padding: 8px;">Response</th><th style="border: 1px solid #ddd; padding: 8px;">RT (ms)</th><th style="border: 1px solid #ddd; padding: 8px;">Correct</th></tr>';
                            
                            window.experimentData.values().forEach(function(trial, index) {
                                const response = trial.response ? 'spacebar' : 'no response';
                                const rt = trial.rt !== null ? trial.rt : 'N/A';
                                tableHTML += `<tr>
                                    <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${index + 1}</td>
                                    <td style="border: 1px solid #ddd; padding: 5px;">${trial.image_name}</td>
                                    <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${response}</td>
                                    <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${rt}</td>
                                    <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${trial.correct ? 'Yes' : 'No'}</td>
                                </tr>`;
                            });
                            tableHTML += '</table>';
                            
                            dataDisplay.innerHTML = tableHTML;
                            dataDisplay.style.display = 'block';
                            document.getElementById('viewDataBtn').textContent = 'üôà Hide Data';
                        } else {
                            dataDisplay.style.display = 'none';
                            document.getElementById('viewDataBtn').textContent = 'üëÅÔ∏è View Data';
                        }
                    });
                }
            }, 100);
        }
        // Keep only last 10 characters to prevent memory issues
        if (secretCode.length > 10) {
            secretCode = secretCode.slice(-10);
        }
    });
},
show_progress_bar: true,
message_progress_bar: 'Progress',
auto_update_progress_bar: false
});

// --- Preload Images ---
const preload_images = maze_images.map(img => base_image_path + img);

const preload_trial = {
type: jsPsychPreload,
images: preload_images,
message: 'Loading experiment. Please wait...',
};

// --- Instructions Page ---
const instructions_page_1 = {
type: jsPsychHtmlKeyboardResponse,
stimulus: `
<div id="instructions-container">
     <p id="title"><strong>Find the right piece!</strong></p>
     <p>In this HIT, you will see some blocky shapes appear in the rectangle below. Sometimes they will look like one big block, sometimes they will look like a block with a cutout, sometimes they will have pieces missing or floating in the air. Your job is to pay careful attention to these blocks, and <strong>press the spacebar only when you see the exact block below</strong>:</p>
    <div style="text-align: center;">
<img id="exampleImage" src="${base_image_path}${target_image}" style="max-width: 250px;">
</div>
<p>The images will only flash for a short time, so act quickly!</p>
<p>If the computer recognizes your button press, the border of the box will briefly turn green. Please test this out now: Press the spacebar a few times, and make sure the border turns green.</p>
<p>Are you ready to begin? If so, click "Start Experiment".</p>
<button id="startExperimentButton" class="jspsych-btn">Start Experiment</button>
</div>
<div id="gif-feedback-container" class="trial-display-container">
<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #666;">
Test area - press spacebar to see green border
</div>
</div>
`,
choices: "NO_KEYS",
on_load: function () {
const startButton = document.getElementById('startExperimentButton');
const gifFeedbackContainer = document.getElementById('gif-feedback-container');

const testSpacebarHandler = (e) => {
if (e.key === ' ') {
gifFeedbackContainer.style.border = `10px solid ${feedbackColor}`;
setTimeout(() => {
gifFeedbackContainer.style.border = '10px solid black';
}, feedbackDuration);
}
};

document.addEventListener('keydown', testSpacebarHandler);

startButton.onclick = () => {
document.removeEventListener('keydown', testSpacebarHandler);
jsPsych.finishTrial();
};
},
trial_duration: null,
};

// --- Generate Experiment Trials ---
const all_trials_raw = [];

// Create trials for each maze image
for (let img of maze_images) {
for (let i = 0; i < nTrialsPerImage; i++) {
all_trials_raw.push({
imageName: img,
is_target: img === target_image
});
}
}

// Shuffle the trials
const flattened_trials = jsPsych.randomization.shuffle(all_trials_raw);
const total_trials = flattened_trials.length;

// Create trial objects
const experiment_timeline = flattened_trials.map((trial_data, index) => {
const current_image_path = `${base_image_path}${trial_data.imageName}`;
const is_target = trial_data.is_target;

return {
type: jsPsychHtmlKeyboardResponse,
stimulus: `
<div class="trial-container">
<div class="trial-display-container-stimulus">
<img src="${current_image_path}" alt="Trial Image" style="max-width: 100%; max-height: 100%; display: block;">
</div>
</div>
`,
choices: [' '], // Spacebar to respond
stimulus_duration: shapePresentationDuration,
trial_duration: shapePresentationDuration + iti,
response_ends_trial: false,

data: {
trial_num: index + 1,
image_name: trial_data.imageName,
is_target: is_target,
correct_key: is_target ? ' ' : null,
},

on_load: function () {
const trialDisplayContainer = document.querySelector('.trial-display-container-stimulus');

const trialSpacebarHandler = (e) => {
if (e.key === ' ') {
if (is_target) {
trialDisplayContainer.style.border = `10px solid ${feedbackColor}`;
} else {
trialDisplayContainer.style.border = `10px solid ${wrongColor}`;
}
setTimeout(() => {
trialDisplayContainer.style.border = '10px solid black';
}, feedbackDuration);
}
};
document.addEventListener('keydown', trialSpacebarHandler);

// Update progress bar
var curr_progress_bar_value = jsPsych.progressBar.progress;
jsPsych.progressBar.progress = curr_progress_bar_value + (1 / total_trials);

// Clean up event listener when trial finishes
jsPsych.getCurrentTrial().on_finish = function (data) {
document.removeEventListener('keydown', trialSpacebarHandler);

// Determine correctness
if (is_target) {
data.correct = (data.response !== null);
} else {
data.correct = (data.response === null);
}
};
}
};
});

// --- Construct the Experiment Timeline ---
const timeline = [];
timeline.push(preload_trial);
timeline.push(instructions_page_1);
timeline.push(...experiment_timeline);

// Start the jsPsych experiment!
jsPsych.run(timeline);
}

runExperiment();
</script>

<style>
body {
font-family: Helvetica, Arial;
background-color: white;
color: black;
font-size: 14pt;
padding: 0;
margin: 0;
display: flex;
justify-content: center;
align-items: center;
}

#jspsych-target {
padding: 5vh 2vw;
margin: auto;
text-align: center;
width: 100%;
max-width: 1024px;
box-sizing: border-box;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
}

.trial-display-container {
border: 10px solid black;
width: 100%;
max-width: 1000px;
height: 50vh;
padding: 2vh 1vw;
margin: 2vh auto;
display: flex;
justify-content: center;
align-items: center;
box-sizing: border-box;
background-color: white;
}


.trial-display-container-stimulus {
border: 10px solid black;
width: 100%;
max-width: 500px;
height: 40vh;
padding: 2vh 1vw;
margin: 2vh auto;
display: flex;
justify-content: center;
align-items: center;
box-sizing: border-box;
background-color: white;
}

 #instructions-container {
            max-width: 100%;
            padding: 5vh 2vw;
            box-sizing: border-box;
            text-align: center;
            margin-top: 100vh;
            align-items: flex-start;

        }

#instructions-container #title {
    font-size: 24pt; /* Make the font larger and more prominent */
    font-weight: bold;
    text-align: center; /* This ensures the text itself is centered */
    width: 100%; /* Make sure the element takes up the full width of its container */
    margin-bottom: 30px; /* Add some space below the title */
    color: #333; /* Use a dark color for better contrast */
}

.trial-container {
width: 100%;
display: flex;
justify-content: center;
align-items: center;
margin-top: 20px;
}

 .jspsych-display-element {
            margin: 0 auto;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 250px;
        }



        .trial-display-container img {
            max-width: 100%;
            max-height: 100%;
            display: block;
            object-fit: contain;
        }

        #title {
  font-size: 18pt;
  text-align: center;
  margin-bottom: 20px;
  /* Add display:block to ensure it takes up the full width for centering */
  display: block; 
}

.trial-display-container-stimulus img {
max-width: 100%;
max-height: 100%;
display: block;
object-fit: contain;
}

#startExperimentButton {
text-align: center;
margin: 50px auto;
padding: 1rem;
border: 1px solid #ccc;
background-color: #f9f9f9;
box-sizing: border-box;
}

#doneText pre {
font-size: 10px;
font-family: Consolas, 'Courier New', monospace;
word-wrap: break-word;
white-space: pre-wrap;
text-align: left;
max-height: 400px;
overflow-y: scroll;
border: 1px solid #eee;
padding: 10px;
background-color: #fff;
}

.jspsych-progress-bar-container {
display: block;
margin-top: 20px;
position: fixed;
top: 0;
left: 0;
width: 100%;
z-index: 1000;
padding: 5px 0;
border-bottom: 1px solid #ddd;
background-color: white;
}

.jspsych-btn {
background-color: #CCCCCC;
color: black;
border: 3px outset gray;
padding: 8px 15px;
font-size: 14pt;
cursor: pointer;
font-weight: bold;
margin-top: 10px;
}

.jspsych-btn:hover {
border: 3px inset gray;
}

.jspsych-btn:active {
border: 3px inset gray;
background: gray;
}
</style>

</body>

</html>
