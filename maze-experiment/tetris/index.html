<!DOCTYPE html>
<html>

<head>
    <title>Tetris OtomatiÄŸi Deneyi</title>
    <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/jspsych@8.2.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@2.1.0"></script>
</head>

<body>
    <div id="jspsych-target"></div>

    <script>
        // --- Experiment Parameters ---
        const matchness_types = ["match", "mismatch"];
        const target_shape_name = "square";
        const nontarget_shape_name = "bottom";

        const nTrialsPerTrialType = 6;
        const n_trials = matchness_types.length * nTrialsPerTrialType * 3 +
            matchness_types.length * nTrialsPerTrialType * 3 +
            nTrialsPerTrialType * 2;
        const targetRepeats = 2;
        const fillerRepeats = 2;

        const iti = 1200; // Inter-trial interval (msec)
        const shapePresentationDuration = 600; // Image display duration (msec)

        const feedbackColor = '#008000'; // Green for correct responses
        const wrongColor = '#FF0000'; // Red for incorrect responses
        const feedbackDuration = 300; // How long the border color stays changed after a response

        async function runExperiment() {
            const jsPsych = initJsPsych({
                on_finish: function (data) {
                    document.body.innerHTML = `
                        <div id="doneText" style="text-align: center; padding: 20px;">
                            <strong>Done! Thank you for your participation.</strong>
                            
                        </div>
                    `;
                },
                show_progress_bar: true,
                message_progress_bar: 'Progress',
                auto_update_progress_bar: false
            });

            // --- Preload Images ---
            const preload_images = [];
            for (let i = 0; i < matchness_types.length; i++) {
                for (let j = 1; j <= nTrialsPerTrialType; j++) {
                    preload_images.push(`https://cxx.perceptionresearch.org/Tetris/Tetris_3D_square/${matchness_types[i]}_${j}.png`);
                }
            }
            preload_images.push(`https://cxx.perceptionresearch.org/Tetris/Tetris_3D_square/${target_shape_name}.png`);
            for (let i = 1; i <= nTrialsPerTrialType; i++) {
                preload_images.push(`https://cxx.perceptionresearch.org/Tetris/Tetris_3D_square/${nontarget_shape_name}_${i}.png`);
            }
            preload_images.push(`https://cxx.perceptionresearch.org/Tetris/Tetris_3D_square/instruction_${target_shape_name}.gif`);

            const preload_trial = {
                type: jsPsychPreload,
                images: preload_images,
                message: 'Loading experiment. Please wait...',
            };
            // --- End Preload Images ---

            // --- Instructions Page 1 (Initial Welcome, Target, and GIF Example) ---
            // --- Instructions Page 1 (Initial Welcome, Target, and GIF Example) ---
            const instructions_page_1 = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `
                    <div id="instructions-container">
                        <p id="title"><strong>Find the right piece!</strong></p>
                        <p>In this HIT, you will see some blocky shapes appear in the rectangle below. Sometimes they will look like one big block, sometimes they will look like a block with a cutout, sometimes they will have pieces missing or floating in the air. Your job is to pay careful attention to these blocks, and <strong>press the spacebar only when you see the exact block below</strong>:</p>
                        <div style="text-align: center;">
                            <img id="exampleImage" src="https://cxx.perceptionresearch.org/Tetris/Tetris_3D_square/${target_shape_name}.png" style="max-width: 250px;">
                        </div>
                        <p>You can also see examples of this and other kinds of blocks flashing below, which will give you an idea of when you should and shouldn't respond. Again, only press the spacebar for the image you see above!</p>
                        <p>The images will only flash for one second each, so act quickly!</p>
                        <p>If the computer recognizes your button press, the border of the box will briefly turn green. Please test this out now: Press the spacebar a few times, and make sure the border turns green. If it does not, you may not be eligible for this HIT.</p>
                        <p>The whole HIT will only take a few minutes; please stay focused!</p>
                        <p>Are you ready to begin? If so, click "Start Experiment". By completing this survey or questionnaire, you are consenting to be in this research study. Your participation is voluntary and you can stop at any time.</p>
                        <p style ="font-size:8pt">(Note: When the experiment is done, you will be told it is done, and then you can click the 'submit' button. If that fails to work, the HIT should "auto-submit" after 1 minute)</p>
                        <button id="startExperimentButton" class="jspsych-btn">Start Experiment</button>
                    </div>
                    <div id="gif-feedback-container" class="trial-display-container">
                        <img id="instructionGif" src="https://cxx.perceptionresearch.org/Tetris/Tetris_3D_square/instruction_${target_shape_name}.gif" style="max-width: 100%; max-height: 100%; display: block;">
                    </div>
                    <button id="submitButton" class="jspsych-btn">Submit</button>
                    `,
                choices: "NO_KEYS",
                on_load: function () {
                    const startButton = document.getElementById('startExperimentButton');
                    const gifFeedbackContainer = document.getElementById('gif-feedback-container');

                    const testSpacebarHandler = (e) => {
                        if (e.key === ' ') {
                            gifFeedbackContainer.style.border = `10px solid ${feedbackColor}`;
                            setTimeout(() => {
                                gifFeedbackContainer.style.border = '10px solid black';
                            }, feedbackDuration);
                        }
                    };

                    document.addEventListener('keydown', testSpacebarHandler);

                    startButton.onclick = () => {
                        document.removeEventListener('keydown', testSpacebarHandler);
                        jsPsych.finishTrial();
                    };
                },
                trial_duration: null,
            };
            // --- End Instructions Page 1 ---

            // --- Generate Experiment Trials ---
            const all_trials_raw = [];

            for (let i = 0; i < matchness_types.length; i++) {
                for (let j = 1; j <= nTrialsPerTrialType; j++) {
                    const base_trial_info = {
                        matchness: matchness_types[i],
                        id: j,
                        imageName: `${matchness_types[i]}_${j}.png`,
                    };
                    const target_trial_info = {
                        matchness: 'target',
                        id: 0,
                        imageName: `${target_shape_name}.png`,
                    };

                    for (let k = 0; k < targetRepeats; k++) {
                        all_trials_raw.push(base_trial_info);
                        all_trials_raw.push(target_trial_info);
                    }
                }
            }

            for (let i = 0; i < matchness_types.length; i++) {
                for (let j = 1; j <= nTrialsPerTrialType; j++) {
                    const filler_trial_info = {
                        matchness: `${matchness_types[i]}_filler`,
                        id: j,
                        imageName: `${matchness_types[i]}_${j}.png`,
                    };
                    for (let k = 0; k < fillerRepeats; k++) {
                        all_trials_raw.push(filler_trial_info);
                    }
                }
            }

            for (let i = 1; i <= nTrialsPerTrialType; i++) {
                const nontarget_filler_info = {
                    matchness: `nontarget_filler`,
                    id: i,
                    imageName: `${nontarget_shape_name}_${i}.png`,
                };
                for (let k = 0; k < fillerRepeats; k++) {
                    all_trials_raw.push(nontarget_filler_info);
                }
            }

            const flattened_trials = jsPsych.randomization.shuffle(all_trials_raw);

            // This is the crucial part: map over the flattened_trials to create individual trial objects
            const experiment_timeline = flattened_trials.map((trial_data, index) => {
                const current_image_path = `https://cxx.perceptionresearch.org/Tetris/Tetris_3D_square/${trial_data.imageName}`;
                const is_target = (trial_data.matchness === 'target' || trial_data.imageName === `${target_shape_name}.png`);




                return {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: `
                        <div class="trial-container">
                            <div class="trial-display-container-stimulus">
                                <img src="${current_image_path}" alt="Trial Image" style="max-width: 100%; max-height: 100%; display: block;">
                            </div>
                        </div>
                    `,
                    choices: [' '], // Spacebar to respond, consistent with instructions
                    stimulus_duration: shapePresentationDuration,
                    // If you want feedback to appear and then disappear before the next trial,
                    // you might need a different structure or adjust trial_duration and post_trial_gap.
                    // For now, let's keep it simple: stimulus shows, user responds, then it goes to ITI.
                    trial_duration: shapePresentationDuration + iti, // Image + ITI duration
                    response_ends_trial: false, // Image stays for full stimulus_duration regardless of response

                    data: {
                        trial_num: index + 1,
                        matchness: trial_data.matchness,
                        trial_id: trial_data.id,
                        image_name: trial_data.imageName,
                        target_shape: target_shape_name,
                        correct_key: is_target ? ' ' : null, // Corrected to ' ' (space)
                    },
                    on_load: function () {
                        const trialDisplayContainer = document.querySelector('.trial-display-container-stimulus');
                        let responseGiven = false; // Flag to ensure feedback only applies to the first response

                        const trialSpacebarHandler = (e) => {
                            if (e.key === ' ') {

                                if (is_target) {
                                    trialDisplayContainer.style.border = `10px solid ${feedbackColor}`;
                                } else {
                                    trialDisplayContainer.style.border = `10px solid ${wrongColor}`;
                                }
                                setTimeout(() => {
                                    trialDisplayContainer.style.border = '10px solid black';
                                }, feedbackDuration);
                            }
                        };
                        document.addEventListener('keydown', trialSpacebarHandler);

                        var curr_progress_bar_value = jsPsych.progressBar.progress;
                        jsPsych.progressBar.progress = curr_progress_bar_value + (1 / n_trials);

                        console.log("Current progress bar value:", jsPsych.progressBar.progress);


                        // This is crucial: Clean up the event listener when the trial finishes
                        jsPsych.getCurrentTrial().on_finish = function (data) {



                            document.removeEventListener('keydown', trialSpacebarHandler);
                            // Determine correctness based on the response
                            if (is_target) {
                                data.correct = (data.response !== null)
                            } else {
                                data.correct = (data.response === null); // Correct if no response for non-target
                            }
                        };

                        if (index === flattened_trials.length - 1) {
                            // If this is the last trial, we can remove the progress bar
                            jsPsych.finishTrial();
                        }
                    }
                };
            });

            // --- End Generate Experiment Trials ---

            // --- Construct the Experiment Timeline ---
            const timeline = [];
            timeline.push(preload_trial);
            timeline.push(instructions_page_1);
            timeline.push(...experiment_timeline); // Spread operator to add all trials

            // Add the final completion screen



            // Start the jsPsych experiment!
            jsPsych.run(timeline);
        }

        runExperiment();
    </script>

    <style>
        body {
            font-family: Helvetica, Arial;
            background-color: white;
            color: black;
            font-size: 14pt;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;


        }


        #jspsych-target {
            padding: 5vh 2vw;
            margin: auto;
            text-align: center;
            width: 100%;
            max-width: 1024px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .trial-display-container {
            border: 10px solid black;
            width: 100%;
            max-width: 1000px;
            height: 50vh;
            /* veya min-height ile sabitlenebilir */
            padding: 2vh 1vw;
            margin: 2vh auto;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            background-color: white;
        }

        #instructions-container {
            max-width: 100%;
            padding: 5vh 2vw;
            box-sizing: border-box;
            text-align: center;
            margin-top: 100vh;
            align-items: flex-start;

        }


        .trial-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .jspsych-display-element {
            margin: 0 auto;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 250px;
        }



        .trial-display-container img {
            max-width: 100%;
            max-height: 100%;
            display: block;
            object-fit: contain;
        }



        #title {
            font-size: 18pt;
            text-align: center;
            margin-bottom: 20px;
        }

        #startExperimentButton {

            text-align: center;
            margin: 50px auto;
            padding: 1rem;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            box-sizing: border-box;
        }

        #doneText pre {
            font-size: 10px;
            font-family: Consolas, 'Courier New', monospace;
            word-wrap: break-word;
            white-space: pre-wrap;
            text-align: left;
            max-height: 400px;
            overflow-y: scroll;
            border: 1px solid #eee;
            padding: 10px;
            background-color: #fff;
        }

        .jspsych-progress-bar-container {
            display: none;
            margin-top: 20px;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;

            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }

        .jspsych-btn {
            background-color: #CCCCCC;
            color: black;
            border: 3px outset gray;
            padding: 8px 15px;
            font-size: 14pt;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;

        }

        .jspsych-btn:hover {
            border: 3px inset gray;
        }

        .jspsych-btn:active {
            border: 3px inset gray;
            background: gray;
        }
    </style>

</body>

</html>